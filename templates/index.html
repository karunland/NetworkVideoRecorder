<!doctype html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RTSP Stream Controller</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css">

</head>

<body>
  <!-- <div class="container-fluid">
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container">
        <a class="navbar-brand" href="#">Navbar</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
          aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Features</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Pricing</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" aria-disabled="true">Disabled</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </div> -->

  <div class="container mt-5">
    <div class="row">
      <div class="row mb-5">
        <div class="d-flex">
          <h1 class="mx-auto" style="font-size: 32px;">Network Video Recorder <img style="max-width: 60px;" src="https://cdn.worldvectorlogo.com/logos/raspberry-pi.svg" alt="rpi"></h1>
        </div>
      </div>
      <div class="col-md-6">
        <h4>Update Streaming Credentials</h4>
        <form id="credentialsForm">
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" name="username" placeholder="Enter username"
              value="{{ username }}">
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="text" class="form-control" id="password" name="password" placeholder="Enter password"
              value="{{ password }}">
          </div>
          <button type="button" class="btn btn-primary" id="updateCredentialsButton">Update</button>
        </form>
      </div>
      <div class="col-md-6">
        <div class="row mb-3">
          <div class="mb-2">RTSP Stream Status: <span id="cameraStatus"
              class="badge bg-{{ 'success' if status else 'danger' }}">{{ 'Online' if
              status else 'Offline'}}</span></div>
          <div class="d-flex">
            <div>
              <button id="startCameraButton" class="mx-2 btn btn-success btn-sm">Start Camera</button>
              <button id="stopCameraButton" class="mx-2 btn btn-danger btn-sm">Stop Camera</button>
            </div>
            <div style="margin-left: auto !important;">
              <button id="startCameraButton" class="mx-2 btn btn-success btn-sm">Start Recording</button>
            </div>
          </div>
        </div>
        <div class="row" id="videoContainer">
          <img id="video_feed" src="" alt="RTSP Yay覺n覺">
        </div>
      </div>
    </div>
    <footer class="row" style="margin-top: 20px;">
      <hr>
      <p style=" text-align: center">Check out Pi Security Camera
          <a href="https://github.com/MieszkoMakuch/pi-security-camera">Github repository</a>.
      </p>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
              integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
              crossorigin="anonymous"></script>
  </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
</body>

</html>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
  $(document).ready(function () {

    toastr.options = {
      "closeButton": false,
      "debug": false,
      "newestOnTop": true,
      "progressBar": true,
      "positionClass": "toast-top-right",
      "preventDuplicates": true,
      "onclick": null,
      "showDuration": "300",
      "hideDuration": "1000",
      "timeOut": "5000",
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    }

    $('#updateCredentialsButton').click(function () {
      var username = $('#username').val();
      var password = $('#password').val();

      $.ajax({
        url: '/',
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ username: username, password: password }),
        success: function (data) {
          toastr.success(data.message);
        },
        error: function (xhr, status, error) {
          toastr.error('Error:', error);
        }
      });
    });

    $('#stopCameraButton').click(function () {
      $.get('/stop', function (data) {
        toastr.success(data.message);
      }).fail(function () {
        toastr.error("Error stopping the camera.");
      });
    });

    function updateCameraStatus(data) {
      var statusElement = $('#cameraStatus');
      if (data.status) {
        statusElement.removeClass('bg-danger').addClass('bg-success');
        statusElement.text('Online');
      } else {
        statusElement.removeClass('bg-success').addClass('bg-danger');
        statusElement.text('Offline');
      }
    }

    $("#startCameraButton").click(function () {
      $.get('/start', function (data) {
        toastr.success(data.message);
        updateCamera();
      }).fail(function () {
        toastr.error("Error starting the camera.");
      });
    });

    setInterval(function () {
      $.getJSON('/status', function (data) {
        updateCameraStatus(data);
      }).fail(function () {
        toastr.error("Error getting camera status.");
      })
    }, 1000);

  });

  window.onload = function () {
    startVideoFeed();
  };

  function startVideoFeed() {
    var videoUrl = "http://127.0.0.1:5000/video_feed";
    var videoElement = document.getElementById("video_feed");
    videoElement.src = videoUrl;
  }

  function updateCamera() {
    var videoUrl = "http://127.0.0.1:5000/video_feed";
    var videoElement = $('<img>', { id: 'video_feed', src: videoUrl, alt: 'RTSP Yay覺n覺' });

    $('#videoContainer').empty().append(videoElement);
  }
</script>